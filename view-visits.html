<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>View Visits</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --space-900:#0b1020;--space-800:#111735;--space-700:#1a2448;
    --ink:#e6eaf2;--muted:#93a0ba;--grid:#2c375f;
    --accent:#3ba6ff;--accent-600:#2a8fe0;--ok:#19c37d;--danger:#ff5d5d;
    --shadow:0 18px 60px rgba(0,0,0,.35);--radius:14px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --space-900:#eef2f7;--space-800:#f7f8fb;--space-700:#ffffff;
      --ink:#0f172a;--muted:#5c6b86;--grid:#e6e8ef;
      --accent:#1e40af;--accent-600:#1c3a9b;
      --shadow:0 16px 46px rgba(15,23,42,.10);
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial,sans-serif;
    color:var(--ink);
    background:
      radial-gradient(1200px 800px at 15% 10%, #22306460 0%, #0000 55%),
      radial-gradient(900px 900px at 85% 80%, #134e6a40 0%, #0000 50%),
      var(--space-800);
    padding:24px;
  }
  .shell{max-width:1100px;margin:0 auto}
  .bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px}
  .title{display:flex;align-items:center;gap:12px}
  .mark{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,#1a2448,#0b1020);border:1px solid #243160;box-shadow:inset 0 0 0 1px #36457a}
  h1{margin:0;font-size:clamp(20px,3vw,24px)}
  .btn{
    appearance:none;border-radius:999px;border:1px solid var(--grid);
    background:color-mix(in oklab,var(--space-700) 82%,#000 18%);
    color:var(--ink);font-weight:700;letter-spacing:.08em;text-transform:uppercase;
    font-size:12.5px;padding:12px 16px;display:inline-flex;align-items:center;gap:10px;
    cursor:pointer;transition:transform .1s,background .2s,border-color .2s,box-shadow .2s
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:focus-visible{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px color-mix(in oklab,var(--accent) 35%,transparent)}
  .btn svg{width:16px;height:16px}
  .btn--primary{
    background:linear-gradient(180deg,color-mix(in oklab,var(--accent) 14%,transparent),#0000),
               color-mix(in oklab,var(--accent) 16%,#0e1b33);
    border-color:color-mix(in oklab,var(--accent) 60%,#142043);color:#f4f8ff
  }
  .card{
    background:linear-gradient(180deg,color-mix(in oklab,var(--space-700) 92%,#fff 8%),var(--space-700));
    border:1px solid var(--grid);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 16px
  }
  .filters{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;margin-bottom:14px}
  @media (max-width:800px){.filters{grid-template-columns:1fr 1fr}}
  input,select{
    width:100%;background:color-mix(in oklab,var(--space-700) 88%,#000 12%);
    color:var(--ink);border:1px solid var(--grid);border-radius:10px;padding:10px 12px;font-size:15px
  }
  .timeline{display:grid;gap:12px}
  .visit-item{
    background:color-mix(in oklab,var(--space-700) 92%,#000 8%);
    border:1px solid var(--grid);border-radius:12px;padding:16px;
    display:grid;gap:8px;position:relative;
  }
  .visit-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
  .visit-date{font-weight:700;color:var(--accent)}
  .visit-patient{font-size:18px;font-weight:600}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--grid);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .disease-pill{background:color-mix(in oklab,var(--accent) 15%,transparent);border:1px solid color-mix(in oklab,var(--accent) 40%,var(--grid));border-radius:999px;padding:4px 8px;font-size:12px;color:var(--accent)}
  .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:16px}
  .stat-card{background:color-mix(in oklab,var(--space-700) 88%,#000 12%);border:1px solid var(--grid);border-radius:10px;padding:12px;text-align:center}
  .stat-number{font-size:24px;font-weight:700;color:var(--accent)}
  .stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em}
  .empty{text-align:center;color:var(--muted);padding:40px}
  @media print{.bar,.filters,.btn{display:none !important}.card{box-shadow:none;border:0}}
</style>
</head>
<body>
<div class="shell">
  <div class="bar">
    <div class="title">
      <div class="mark" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="#3ba6ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
          <rect x="3" y="4" width="18" height="18" rx="2"/>
          <path d="M16 2v4M8 2v4M3 10h18"/>
        </svg>
      </div>
      <div>
        <h1>Patient Visits</h1>
        <div class="muted">Visit history and statistics</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn" onclick="goBack()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6"/></svg>
        Back
      </button>
      <button class="btn btn--primary" onclick="location.href='write-prescription.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
        New Visit
      </button>
    </div>
  </div>

  <section class="card">
    <div class="filters">
      <input id="q" type="search" placeholder="Search by patient name..." />
      <input id="dateFilter" type="month" title="Filter by month" />
      <button class="btn" onclick="clearFilters()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18M8 6v12M16 6v12"/></svg>
        Clear
      </button>
    </div>

    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-number" id="totalVisits">0</div>
        <div class="stat-label">Total Visits</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="uniquePatients">0</div>
        <div class="stat-label">Unique Patients</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="thisMonth">0</div>
        <div class="stat-label">This Month</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgPerMonth">0</div>
        <div class="stat-label">Avg/Month</div>
      </div>
    </div>

    <div id="count" class="muted" style="margin:4px 2px 10px"></div>

    <div id="timeline" class="timeline"></div>

    <div id="empty" class="empty" hidden>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="48" height="48" style="margin-bottom:12px;opacity:0.5">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <path d="M16 2v4M8 2v4M3 10h18"/>
      </svg>
      <div>No prescription visits yet.</div>
      <div style="margin-top:8px">Create your first prescription to see visit history.</div>
    </div>
  </section>
</div>

<script>
  const STORAGE_KEY = 'prescriptions';
  const $ = (s,ctx=document)=>ctx.querySelector(s);

  function loadAll(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
    catch{ return []; }
  }

  const timelineEl = $('#timeline');
  const emptyEl = $('#empty');
  const countEl = $('#count');
  let all = loadAll();

  // Sort by date (newest first)
  all.sort((a, b) => {
    const dateA = new Date(a.date || a.createdAt);
    const dateB = new Date(b.date || b.createdAt);
    return dateB - dateA;
  });

  function calculateStats(data) {
    const now = new Date();
    const thisMonth = now.getMonth();
    const thisYear = now.getFullYear();
    
    const totalVisits = data.length;
    const uniquePatients = new Set(data.map(p => p.patientName?.toLowerCase())).size;
    const thisMonthVisits = data.filter(p => {
      const date = new Date(p.date || p.createdAt);
      return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
    }).length;
    
    // Calculate average per month based on data span
    let avgPerMonth = 0;
    if (data.length > 0) {
      const oldest = new Date(data[data.length - 1].date || data[data.length - 1].createdAt);
      const newest = new Date(data[0].date || data[0].createdAt);
      const monthsDiff = Math.max(1, (newest.getFullYear() - oldest.getFullYear()) * 12 + (newest.getMonth() - oldest.getMonth()) + 1);
      avgPerMonth = Math.round(totalVisits / monthsDiff * 10) / 10;
    }
    
    $('#totalVisits').textContent = totalVisits;
    $('#uniquePatients').textContent = uniquePatients;
    $('#thisMonth').textContent = thisMonthVisits;
    $('#avgPerMonth').textContent = avgPerMonth;
  }

  function render(){
    const q = ($('#q').value || '').toLowerCase().trim();
    const dateFilter = $('#dateFilter').value; // YYYY-MM format

    const filtered = all.filter(p=>{
      const nameMatch = !q || (p.patientName || '').toLowerCase().includes(q);
      
      let dateMatch = true;
      if (dateFilter) {
        const visitDate = new Date(p.date || p.createdAt);
        const filterDate = `${visitDate.getFullYear()}-${String(visitDate.getMonth() + 1).padStart(2, '0')}`;
        dateMatch = filterDate === dateFilter;
      }
      
      return nameMatch && dateMatch;
    });

    calculateStats(all);
    countEl.textContent = `${filtered.length} of ${all.length} visits`;
    timelineEl.innerHTML = '';
    emptyEl.hidden = filtered.length !== 0;

    // Group by date for better organization
    const groupedByDate = {};
    filtered.forEach(p => {
      const date = new Date(p.date || p.createdAt);
      const dateKey = date.toDateString();
      if (!groupedByDate[dateKey]) {
        groupedByDate[dateKey] = [];
      }
      groupedByDate[dateKey].push(p);
    });

    Object.entries(groupedByDate).forEach(([dateKey, visits]) => {
      visits.forEach((p, index) => {
        const visitDate = new Date(p.date || p.createdAt);
        const isFirstOfDay = index === 0;
        
        const card = document.createElement('article');
        card.className = 'visit-item';
        card.innerHTML = `
          <div class="visit-header">
            <div>
              ${isFirstOfDay ? `<div class="visit-date">${visitDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              })}</div>` : ''}
              <div class="visit-patient">${escapeHtml(p.patientName || 'Unnamed Patient')}</div>
            </div>
            <div class="row">
              <span class="badge">#${p.id}</span>
              ${p.age ? `<span class="badge">${p.age} yrs</span>` : ''}
              ${p.sex ? `<span class="badge">${p.sex === 'M' ? 'Male' : p.sex === 'F' ? 'Female' : 'Other'}</span>` : ''}
            </div>
          </div>
          
          ${renderDiseases(p)}
          ${p.diagnosis ? `<div><strong>Diagnosis:</strong> ${escapeHtml(p.diagnosis)}</div>` : ''}
          
          ${p.meds && p.meds.length > 0 ? `
            <div>
              <strong>Medications (${p.meds.length}):</strong>
              <div class="row" style="margin-top:4px">
                ${p.meds.slice(0, 4).map(m => `
                  <span style="background:color-mix(in oklab,var(--space-700) 88%,#000 12%);border:1px solid var(--grid);border-radius:6px;padding:4px 8px;font-size:12px">
                    ${escapeHtml(m.name)} ${escapeHtml(m.dosage || '')}
                  </span>
                `).join('')}
                ${p.meds.length > 4 ? `<span style="color:var(--muted);font-size:12px">+${p.meds.length - 4} more</span>` : ''}
              </div>
            </div>
          ` : '<div class="muted">No medications prescribed</div>'}
          
          ${p.notes ? `<div class="muted"><strong>Notes:</strong> ${escapeHtml(p.notes)}</div>` : ''}
          
          <div class="row" style="margin-top:8px">
            <button class="btn" onclick="viewPrescription(${p.id})" style="font-size:11px;padding:6px 10px">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="14" height="14">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <path d="M14 2v6h6"/>
              </svg>
              View Details
            </button>
            <button class="btn" onclick="printPrescription(${p.id})" style="font-size:11px;padding:6px 10px">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="14" height="14">
                <path d="M6 9V3h12v6"/>
                <rect x="6" y="13" width="12" height="8" rx="2"/>
                <path d="M6 17h12"/>
              </svg>
              Print
            </button>
          </div>
        `;
        timelineEl.appendChild(card);
      });
    });
  }

  function renderDiseases(p){
    let diseases = [];
    
    if (p.diseases && Array.isArray(p.diseases)) {
      diseases = p.diseases;
    } else if (p.disease) {
      // Handle legacy single disease
      diseases = [{ name: p.disease, days: 0 }];
    }

    if (diseases.length === 0) {
      return '<div class="muted">No diseases recorded</div>';
    }

    return `<div>
      <strong>Diseases:</strong>
      <div class="row" style="margin-top:4px">
        ${diseases.map(d => {
          const name = d.name || '';
          const days = d.days || 0;
          const duration = days > 0 ? ` (${days}d)` : '';
          return `<span class="disease-pill">${escapeHtml(name)}${duration}</span>`;
        }).join('')}
      </div>
    </div>`;
  }

  function viewPrescription(id){
    location.href = `view-prescription.html?highlight=${id}`;
  }

  function printPrescription(id){
    const p = all.find(x => x.id === id);
    if (!p) return;
    
    localStorage.setItem('printPrescription', JSON.stringify(p));
    location.href = `print-prescription.html?id=${id}`;
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, m=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  $('#q').addEventListener('input', render);
  $('#dateFilter').addEventListener('input', render);
  function clearFilters(){ $('#q').value=''; $('#dateFilter').value=''; render(); }

  function goBack(){
    if (document.referrer && history.length>1) history.back(); else location.href='index.html';
  }

  render();
</script>

</body>
</html>
